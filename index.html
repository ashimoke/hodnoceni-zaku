<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hodnocení žáků</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    button, select { margin: 0.5em 0; font-size: 1em; padding: 0.5em; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    .container { max-width: 800px; margin: auto; }
    .rating-group { display: flex; flex-direction: column; margin-bottom: 1.5em; }
    .student-name { font-weight: bold; margin-bottom: 0.5em; }
    .rating-row { display: flex; gap: 0.5em; flex-wrap: wrap; justify-content: flex-start; }
    .rating-cell { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
    .rating-cell .category { font-size: 0.75em; text-align: center; margin-bottom: 0.2em; }
    .error { color: red; font-weight: bold; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://fedvxxsvrnacggdcbfml.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlZHZ4eHN2cm5hY2dnZGNiZm1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3MTIzMDgsImV4cCI6MjA2NTI4ODMwOH0.Y9hFTKw2676_sJX65ibKcv28Jb51I9AFsRODLbDjS7U'
    );

    const evaluators = ["Hrubeš", "Horák", "Kubelka", "Mrázik", "Uher"].sort();
    const students = {
      "3.N": ["Jakubíková", "Kasho", "Kašparcová", "Kotásková", "Marková", "Mórová", "Nespjaková", "Olšák", "Poláčková", "Šmíd", "Vaňousová", "Zelyczová"].sort(),
      "2.DN": ["Bláhová", "Bukovský", "Eisnerová", "Foryová", "Holienková", "Janatková", "Kodad", "Košata", "Matějíková", "Matys", "Nováková", "Otradovcová", "Vokalová"].sort(),
    };
    const ratings = ["", "1.0", "1.5", "2.0", "2.5", "3.0", "3.5", "4.0", "4.5", "5.0"];
    const categories = ["návrh", "model", "katalog", "tech.", "obhajoba"];
    let selectedClass = "";
    let selectedEvaluator = "";

    function show(id) {
      document.querySelectorAll("#page-start, #page-select-evaluator, #page-rating, #page-results").forEach(e => e.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    window.selectClass = function(cls) {
      selectedClass = cls;
      const container = document.getElementById("evaluator-buttons");
      container.innerHTML = "";
      evaluators.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = function () { selectEvaluator(name); };
        container.appendChild(btn);
      });
      show("page-select-evaluator");
    }

    async function selectEvaluator(name) {
      selectedEvaluator = name;
      document.getElementById("rating-title").textContent = `Hodnocení žáků třídy ${selectedClass} hodnotitelem ${name}`;
      const form = document.getElementById("rating-form");
      form.innerHTML = "Načítání dat...";
      show("page-rating");

      try {
        const res = await supabase
          .from('ratings')
          .select('*')
          .eq('trida', selectedClass)
          .eq('hodnotitel', selectedEvaluator);

        if (res.error) throw res.error;

        const existingRatings = {};
        res.data.forEach(row => {
          existingRatings[row.zaktarget] = row;
        });

        form.innerHTML = "";
        students[selectedClass].forEach(student => {
          const group = document.createElement("div");
          group.className = "rating-group";

          const name = document.createElement("div");
          name.className = "student-name";
          name.textContent = student;
          group.appendChild(name);

          const row = document.createElement("div");
          row.className = "rating-row";

          categories.forEach(cat => {
            const cell = document.createElement("div");
            cell.className = "rating-cell";

            const span = document.createElement("span");
            span.className = "category";
            span.textContent = cat;
            cell.appendChild(span);

            const select = document.createElement("select");
            select.id = `rating-${student}-${cat}`;
            ratings.forEach(val => {
              const option = document.createElement("option");
              option.value = val;
              option.textContent = val || "--";
              select.appendChild(option);
            });
            if (existingRatings[student] && existingRatings[student][cat] !== null) {
              select.value = Number(existingRatings[student][cat]).toFixed(1);
            }
            cell.appendChild(select);
            row.appendChild(cell);
          });

          group.appendChild(row);
          form.appendChild(group);
        });
      } catch (err) {
        form.innerHTML = `<p class='error'>Chyba při načítání: ${err.message}</p>`;
        console.error("Chyba při načítání dat:", err);
      }
    }

    window.saveRatings = async function() {
      const newRatings = [];

      for (const student of students[selectedClass]) {
        const ratingObj = {
          trida: selectedClass,
          hodnotitel: selectedEvaluator,
          zaktarget: student
        };

        let hasValue = false;

        categories.forEach(cat => {
          const val = document.getElementById(`rating-${student}-${cat}`).value;
          const parsed = parseFloat(val);
          if (val && !isNaN(parsed)) {
            ratingObj[cat] = parsed;
            hasValue = true;
          } else {
            ratingObj[cat] = null;
          }
        });

        if (hasValue) newRatings.push(ratingObj);
      }

      if (newRatings.length > 0) {
        const { error } = await supabase
          .from('ratings')
          .upsert(newRatings, { onConflict: ['trida', 'hodnotitel', 'zaktarget'] });
        if (error) {
          console.error(`Chyba při ukládání hodnocení:`, error.message || JSON.stringify(error));
        }
      }

      alert("Hodnocení uloženo.");
    }

    window.goToResults = function () {
      alert("Zobrazit výsledky – funkce ještě není implementována ve verzi 7");
    }
  </script>
</head>
<body>
<div class="container">
  <h1>Hodnocení žáků – verze 7</h1>

  <div id="page-start">
    <h2>Zvolte třídu</h2>
    <button onclick="selectClass('3.N')">3.N</button>
    <button onclick="selectClass('2.DN')">2.DN</button>
  </div>

  <div id="page-select-evaluator" class="hidden">
    <h2>Zvolte hodnotícího</h2>
    <div id="evaluator-buttons"></div>
  </div>

  <div id="page-rating" class="hidden">
    <h2 id="rating-title"></h2>
    <div id="rating-form"></div>
    <button onclick="saveRatings()">Uložit hodnocení</button>
    <button onclick="goToResults()">Zobrazit výsledky</button>
  </div>
</div>
</body>
</html>
