<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hodnocení žáků</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    button, select { margin: 0.5em 0; font-size: 1em; padding: 0.5em; width: 100%; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    .container { max-width: 600px; margin: auto; }
    .error { color: red; font-weight: bold; }
    .version { text-align: center; font-size: 0.9em; color: #666; margin-top: 1em; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://fedvxxsvrnacggdcbfml.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlZHZ4eHN2cm5hY2dnZGNiZm1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3MTIzMDgsImV4cCI6MjA2NTI4ODMwOH0.Y9hFTKw2676_sJX65ibKcv28Jb51I9AFsRODLbDjS7U'
    );

    const evaluators = ["Hrubeš", "Horák", "Kubelka", "Mrázik", "Uher"].sort();
    const students = {
      "3.N": ["Jakubíková", "Kasho", "Kašparcová", "Kotásková", "Marková", "Mórová", "Nespjaková", "Olšák", "Poláčková", "Šmíd", "Vaňousová", "Zelyczová"].sort(),
      "2.DN": ["Bláhová", "Bukovský", "Eisnerová", "Foryová", "Holienková", "Janatková", "Kodad", "Košata", "Matějíková", "Matys", "Nováková", "Otradovcová", "Vokalová"].sort(),
    };
    const ratings = ["", "1.0", "1.5", "2.0", "2.5", "3.0", "3.5", "4.0", "4.5", "5.0"];
    let selectedClass = "";
    let selectedEvaluator = "";

    function show(id) {
      document.querySelectorAll("#page-start, #page-select-evaluator, #page-rating, #page-results").forEach(e => e.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    window.selectClass = function(cls) {
      selectedClass = cls;
      const container = document.getElementById("evaluator-buttons");
      container.innerHTML = "";
      evaluators.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.onclick = function () { selectEvaluator(name); };
        container.appendChild(btn);
      });
      show("page-select-evaluator");
    }

    async function selectEvaluator(name) {
      selectedEvaluator = name;
      document.getElementById("rating-title").textContent = `Hodnocení žáků třídy ${selectedClass} hodnotitelem ${name}`;
      const form = document.getElementById("rating-form");
      form.innerHTML = "Načítání dat...";
      show("page-rating");

      try {
        const res = await supabase
          .from('ratings')
          .select('*')
          .eq('trida', selectedClass)
          .eq('hodnotitel', selectedEvaluator);

        if (res.error) throw res.error;
        if (!res.data) throw new Error("Data nenalezena nebo nepřišla ze serveru.");

        const existingRatings = {};
        res.data.forEach(row => { existingRatings[row.zaktarget] = row.hodnoceni; });

        form.innerHTML = "";
        students[selectedClass].forEach(student => {
          const div = document.createElement("div");
          const label = document.createElement("label");
          label.textContent = student;
          const select = document.createElement("select");
          ratings.forEach(val => {
            const option = document.createElement("option");
            option.value = val;
            option.textContent = val || "--";
            select.appendChild(option);
          });
          select.value = existingRatings[student] || "";
          select.id = `rating-${student}`;
          div.appendChild(label);
          div.appendChild(select);
          form.appendChild(div);
        });
      } catch (err) {
        form.innerHTML = `<p class='error'>Chyba při načítání: ${err.message}</p>`;
        console.error("Chyba při načítání dat:", err);
      }
    }

    window.saveRatings = async function() {
      const newRatings = [];
      const toDelete = [];

      for (const student of students[selectedClass]) {
        const val = document.getElementById(`rating-${student}`).value;

        if (!val) {
          toDelete.push({
            trida: selectedClass,
            hodnotitel: selectedEvaluator,
            zaktarget: student
          });
          continue;
        }

        const numericVal = parseFloat(val);
        newRatings.push({
          trida: selectedClass,
          hodnotitel: selectedEvaluator,
          zaktarget: student,
          hodnoceni: numericVal
        });
      }

      for (const del of toDelete) {
        const { error } = await supabase
          .from('ratings')
          .delete()
          .match(del);
        if (error) {
          console.error(`Chyba při mazání záznamu:`, error.message || JSON.stringify(error));
        }
      }

      if (newRatings.length > 0) {
        const { error } = await supabase
          .from('ratings')
          .upsert(newRatings);
        if (error) {
          console.error(`Chyba při ukládání hodnocení:`, error.message || JSON.stringify(error));
        }
      }

      alert("Hodnocení uloženo.");
    }

    window.goToResults = async function() {
      const { data, error } = await supabase.from('ratings').select('*');
      if (error) {
        alert("Chyba při načítání výsledků: " + error.message);
        return;
      }

      const div = document.getElementById("results-table");
      div.innerHTML = "";
      Object.keys(students).forEach(cls => {
        const clsHeader = document.createElement("h3");
        clsHeader.textContent = `Třída ${cls}`;
        div.appendChild(clsHeader);

        const table = document.createElement("table");
        const thead = table.insertRow();
        ["Žák", "Průměr", "Hodnotili"].forEach(t => thead.insertCell().textContent = t);

        students[cls].forEach(student => {
          const relevant = data.filter(row => row.trida === cls && row.zaktarget === student);
          const values = relevant.map(r => Number(r.hodnoceni));
          const avg = values.length ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2) : "--";
          const row = table.insertRow();
          row.insertCell().textContent = student;
          row.insertCell().textContent = avg;
          row.insertCell().textContent = relevant.map(r => r.hodnotitel).join(", ");
        });

        div.appendChild(table);
      });

      show("page-results");
    }

    window.goToStart = function() {
      show("page-start");
    }

    document.addEventListener("DOMContentLoaded", () => show("page-start"));
  </script>
</head>
<body>
<div class="container">
  <h1>Hodnocení žáků – verze 2</h1>

  <div id="page-start">
    <h2>Zvolte třídu</h2>
    <button onclick="selectClass('3.N')">3.N</button>
    <button onclick="selectClass('2.DN')">2.DN</button>
  </div>

  <div id="page-select-evaluator" class="hidden">
    <h2>Zvolte hodnotícího</h2>
    <div id="evaluator-buttons"></div>
  </div>

  <div id="page-rating" class="hidden">
    <h2 id="rating-title"></h2>
    <div id="rating-form"></div>
    <button onclick="saveRatings()">Uložit hodnocení</button>
    <button onclick="goToResults()">Zobrazit výsledky</button>
  </div>

  <div id="page-results" class="hidden">
    <h2>Výsledky</h2>
    <div id="results-table"></div>
    <button onclick="goToStart()">Zpět na úvod</button>
  </div>
</div>
</body>
</html>
